DO $$ BEGIN CREATE TYPE CHAT_MESSAGE_ROLE AS ENUM('system', 'user', 'assistant');
EXCEPTION WHEN DUPLICATE_OBJECT THEN NULL; END $$;

CREATE TABLE IF NOT EXISTS users (
	id TEXT NOT NULL PRIMARY KEY,
	customer_id TEXT UNIQUE,
	payment_method TEXT,
	photo TEXT,
	name TEXT NOT NULL,
	email TEXT NOT NULL UNIQUE,
	points INT NOT NULL DEFAULT 0,
	last_charged TIMESTAMPTZ,
	prompt_tokens INT NOT NULL DEFAULT 0,
	completion_tokens INT NOT NULL DEFAULT 0,
	purchased_amount INT NOT NULL DEFAULT 0,
	preview_messages INT NOT NULL DEFAULT 0,
	preview_images INT NOT NULL DEFAULT 0,
	admin BOOL NOT NULL DEFAULT FALSE,
	created TIMESTAMPTZ NOT NULL DEFAULT NOW(),
	updated TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS chats (
	user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
	id TEXT NOT NULL PRIMARY KEY,
	original_id TEXT REFERENCES chats(id),
	name TEXT, -- NULL initially. Immediately generate chat name from initial prompt.
	visible BOOL NOT NULL DEFAULT TRUE,
	created TIMESTAMPTZ NOT NULL DEFAULT NOW(),
	updated TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS chat_messages (
	chat_id TEXT NOT NULL REFERENCES chats(id) ON DELETE CASCADE,
	id TEXT NOT NULL PRIMARY KEY,
	role CHAT_MESSAGE_ROLE NOT NULL,
	text TEXT NOT NULL,
	created TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS images (
	user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
	id TEXT NOT NULL PRIMARY KEY,
	prompt TEXT NOT NULL,
	url TEXT NOT NULL,
	visible BOOL NOT NULL DEFAULT TRUE,
	created TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS conversations (
	user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
	chat_id TEXT NOT NULL REFERENCES chats(id) ON DELETE CASCADE,
	id TEXT NOT NULL PRIMARY KEY,
	slug TEXT NOT NULL,
	title TEXT NOT NULL,
	text TEXT NOT NULL,
	upvotes INT NOT NULL DEFAULT 0,
	downvotes INT NOT NULL DEFAULT 0,
	points INT NOT NULL DEFAULT 0, -- upvotes - downvotes
	views INT NOT NULL DEFAULT 0,
	comments INT NOT NULL DEFAULT 0,
	visible BOOL NOT NULL DEFAULT TRUE,
	created TIMESTAMPTZ NOT NULL DEFAULT NOW(),
	updated TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS conversation_points (
	conversation_id TEXT NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
	user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
	upvote BOOL NOT NULL, -- true for upvote, false for downvote
	created TIMESTAMPTZ NOT NULL DEFAULT NOW(),
	PRIMARY KEY (conversation_id, user_id)
);
